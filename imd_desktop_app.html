<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IMD Material Control - Desktop App</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  
  <!-- CSS Embebido -->
  <style>
/* Versión Bootstrap de los estilos personalizados (ReferenciaCSS_bootstrap.css)
   Mantiene la identidad de colores y un tema oscuro ligero sobre Bootstrap 5 */

:root {
  --axial-primary: #3b82f6;
  --axial-primary-hover: #2563eb;
  --radial-primary: #f97316;
  --radial-primary-hover: #ea580c;
  --bg-dark: #32323E;
  --card-dark: #2d2d2d;
  --border-dark: #404040;
  /* Tipografía base */
  --font-base: 'LG EI', 'LG Regular', system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
  /* Escala tipográfica (1rem = 25px) */
  --fs-2xs: 0.52rem; /* ~13px */
  --fs-xs: 0.6rem;   /* 15px */
  --fs-sm: 0.68rem;  /* 17px */
  --fs-base: 0.75rem;/* 18.75px */
  --fs-md: 0.85rem;  /* 21.25px */
  --fs-lg: 0.95rem;  /* 23.75px */
  --fs-xl: 1.1rem;   /* 27.5px */
  --fs-2xl: 1.25rem; /* 31.25px */
}

html { font-size: 25px; }
body.app-bg {
  background: var(--bg-dark);
  color: #d7d7d7;
  min-height: 100vh;
  font-family: var(--font-base);
  line-height:1.35;
}

h1,h2,h3,h4,h5,h6 { color: #fff; font-family: var(--font-base); font-weight:600; }

/* Tarjetas oscuras */
.card-dark { background: var(--card-dark); border: 1px solid var(--border-dark); }
.card-dark .card-header { border-bottom: 1px solid var(--border-dark); }

/* Encabezados de máquina */
.axial-primary { background: var(--axial-primary) !important; color:#fff; }
.axial-primary.hover-able:hover { background: var(--axial-primary-hover)!important; }
.radial-primary { background: var(--radial-primary)!important; color:#fff; }
.radial-primary.hover-able:hover { background: var(--radial-primary-hover)!important; }

/* Etiquetas laterales de los campos de escaneo */
.scan-pair { display:flex; gap:.5rem; }
.scan-label { width:7.6rem; min-width:7.6rem; background:#475569; color:#f3f4f6; font-size:var(--fs-xs); border-radius:.45rem; display:flex; align-items:center; padding:0 .9rem; font-weight:600; font-family: var(--font-base); }
.scan-input { flex:1; height: 1.8rem; }
.scan-input .form-control { background:#111827; border:1px solid var(--border-dark); color:#fff; font-size: var(--fs-xs); height:1.8rem; padding:.55rem .9rem; font-family: var(--font-base); }
.scan-input .form-control:focus { border-color: var(--axial-primary); box-shadow:0 0 0 .2rem rgba(59,130,246,.25); }
.machine-radial .scan-input .form-control:focus { border-color: var(--radial-primary); box-shadow:0 0 0 .2rem rgba(249,115,22,.25); }

/* Bloques de visualización (Polaridad / Resultado) */
.display-block-title { background:#4b5563; color:#d1d5db; text-align:center; padding: .25rem .45rem .25rem .45rem; border-radius:.375rem .375rem 0 0 ; font-size:var(--fs-xl); font-weight:600; font-family: var(--font-base); }
.display-block { background:#111827; height: 6.56rem; border-radius: 0 0 .65rem .65rem; display:flex; align-items:center; justify-content:center; position:relative; }
.display-block .result-ok { position:absolute; right:.75rem; bottom:.55rem; color:#22c55e; font-size:var(--fs-xl); font-weight:700; }

/* Botón CAMBIAR (ampliado) */
.btn-change { background:#3B7D23; color:#d1d5db; border:1px solid #6b7280; font-weight:600; font-size:var(--fs-xl); padding: .25rem 1.1rem 0.25rem 1.1rem; letter-spacing:.5px; border-radius:.65rem; transition:background .18s ease, transform .15s ease; font-family: var(--font-base); }
.btn-change:hover { background:#499C2C; color:#fff; transform:translateY(-2px); }
.btn-change:active { transform:translateY(0); }

/* Utilidades pequeñas */
.small-title { font-size: var(--fs-xl); font-weight:600; margin-bottom:1rem; font-family: var(--font-base); }
.spacing-y > * + * { margin-top:.75rem; }

/* Aumento de tamaño de fuente dentro del bloque de datos escaneados */
.card .row.flex-grow-1 { font-size: var(--fs-xl); }
/* Ajuste específico de etiquetas e inputs dentro del aumento general */
.card .row.flex-grow-1 .scan-label { font-size: var(--fs-xs); }
.card .row.flex-grow-1 .scan-input .form-control { font-size:var(--fs-sm); }

/* Cards de máquina */
.card-body.d-flex.flex-column { min-height: 20rem;}

/* Responsivo */
@media (max-width: 576px) {
  html { font-size:25px; }
  .scan-label { width:5.6rem; min-width:5.6rem; font-size:var(--fs-2xs); padding:0 .65rem; }
  .scan-input .form-control { height:1.76rem; font-size:var(--fs-md); }
  .display-block { height:5.2rem; }
  .btn-change { font-size:var(--fs-lg); padding:.85rem 1.5rem; }
}
::placeholder {
  color: #9ca3af !important;
  opacity: .55 !important; /* Mejor legibilidad */
  font-size: var(--fs-xs);
  font-family: var(--font-base);
}
.font-lg-ei { font-family: var(--font-base) !important; }
.instructions { font-size: var(--fs-base); font-weight:500; margin: .5rem 0 1rem; color:#e2e8f0; }

/* Enlace de salto (skip link) */
.skip-link { position:absolute; left:-999px; top:auto; width:1px; height:1px; overflow:hidden; }
.skip-link:focus { position:static; width:auto; height:auto; padding:.5rem 1rem; background:#111827; color:#fff; z-index:1000; border:2px solid var(--axial-primary); border-radius:.5rem; }

/* Focus visible accesible */
:focus-visible { outline:2px solid var(--radial-primary); outline-offset:2px; }

/* Estados ARIA utilitarios */
[role="status"], [aria-live] { font-family: var(--font-base); }
.visually-hidden { position:absolute !important; width:1px !important; height:1px !important; padding:0 !important; margin:-1px !important; overflow:hidden !important; clip:rect(0 0 0 0) !important; white-space:nowrap !important; border:0 !important; }

/* Validación de errores - hover rojo para inputs con errores */
.validation-error:hover {
  border-color: #ef4444 !important;
  box-shadow: 0 0 0 .2rem rgba(239, 68, 68, .25) !important;
}

/* Estilos del modal */
.modal-body {
  font-size: var(--fs-sm) !important; /* Reducir tamaño de fuente */
  line-height: 1.4 !important;
}

.modal-title {
  font-size: var(--fs-md) !important; /* Reducir tamaño del título */
}

.card-header.axial-primary.text-center.py-3 {margin-bottom: 0; font-weight: 600; max-height: 3rem;}
.card-header.radial-primary.text-center.py-3 {margin-bottom: 0; font-weight: 600; max-height: 3rem;}
  </style>
</head>
<body class="app-bg py-4">
  <header class="mb-4">
    <div class="container">
      <h1 class="display-6 text-center fw-bold">Control de cambios de material IMD</h1>
    </div>
  </header>
  <!-- Cambiado a container-fluid para ancho completo -->
  <main class="container-fluid pb-4 px-4">
    <!-- La fila ahora ocupa 100% del viewport -->
    <div class="row g-4 px-4">
      <!-- Máquina AXIAL -->
      <div class="col-12 col-lg-6 px-4">
        <div class="card card-dark h-100 machine-axial">
          <div class="card-header axial-primary text-center py-3">
            <h2 class="h5 fw-semibold">Máquina AXIAL</h2>
          </div>
          <div class="card-body d-flex flex-column">
            <h6 class="" style="height: 30px; margin-top: 20px;">Escanea los datos correspondientes en cada campo</h6>
            <div class="row g-4 flex-grow-1">
              <div class="col-12 col-md-8 spacing-y">
                <!-- Pares de etiqueta / input -->
                <div class="scan-pair">
                  <div class="scan-label">QR almacén</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="axial-qr-almacen"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">QR de proveedor</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="axial-qr-proveedor"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">Lote de proveedor</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="axial-lote-proveedor"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">Feeder</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="axial-feeder"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">Polaridad</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="axial-polaridad"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">Persona</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="axial-persona"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">Spec</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Cargando..." id="axial-spec" readonly></div>
                </div>
              </div>
              <div class="col-12 col-md-4 d-flex flex-column gap-3">
                <div>
                  <div class="display-block-title">Polaridad</div>
                  <div class="display-block mt-0" id="axial-polaridad-display">
                  </div>
                </div>
                <div>
                  <div class="display-block-title">Resultado</div>
                  <div class="display-block mt-0" id="axial-resultado-display">
                  </div>
                </div>
              </div>
            </div>
            <!-- Centrado del botón -->
            <div class="mt-4 d-flex justify-content-center">
              <button class="btn btn-change w-75" id="axial-cambiar">CAMBIAR</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Máquina RADIAL -->
      <div class="col-12 col-lg-6 px-4">
        <div class="card card-dark h-100 machine-radial">
          <div class="card-header radial-primary text-center py-3">
            <h2 class="h5 mb-0 fw-semibold">Máquina RADIAL</h2>
          </div>
          <div class="card-body d-flex flex-column">
            <h6 class="" style="height: 30px; margin-top: 20px;">Escanea los datos correspondientes en cada campo</h6>
            <div class="row g-4 flex-grow-1">
              <div class="col-12 col-md-8 spacing-y">
                <!-- Pares de etiqueta / input -->
                <div class="scan-pair">
                  <div class="scan-label">QR almacén</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="radial-qr-almacen"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">QR de proveedor</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="radial-qr-proveedor"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">Lote de proveedor</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="radial-lote-proveedor"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">Feeder</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="radial-feeder"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">Polaridad</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="radial-polaridad"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">Persona</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Escanear..." id="radial-persona"></div>
                </div>
                <div class="scan-pair">
                  <div class="scan-label">Spec</div>
                  <div class="scan-input"><input type="text" class="form-control" placeholder="Cargando..." id="radial-spec" readonly></div>
                </div>
              </div>
              <div class="col-12 col-md-4 d-flex flex-column gap-3">
                <div>
                  <div class="display-block-title" >Polaridad</div>
                  <div class="display-block mt-0" id="radial-polaridad-display">
                  </div>
                </div>
                <div>
                  <div class="display-block-title">Resultado</div>
                  <div class="display-block mt-0" id="radial-resultado-display">
                  </div>
                </div>
              </div>
            </div>
            <!-- Centrado del botón -->
            <div class="mt-4 d-flex justify-content-center">
              <button class="btn btn-change w-75" id="radial-cambiar">CAMBIAR</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal para errores y mensajes -->
  <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title text-white" id="messageModalLabel">Mensaje</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body text-white" id="messageModalBody">
          <!-- El contenido se llenará dinámicamente -->
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  
  <!-- JavaScript Embebido -->
  <script>
// app.js - Lógica para el control de cambios de material IMD
const API_BASE_URL = 'http://127.0.0.1:5000/api';

// Variables globales para cada máquina
const machineStates = {
    axial: {
        machine: 'AXIAL',
        qrAlmacen: '',
        qrProveedor: '',
        loteProveedor: '',
        feeder: '',
        polaridad: '',
        persona: '',
        partNumber: '',
        spec: '',
        dbPolarity: '',
        feederValid: false,
        polarityValid: false,
        allDataReady: false
    },
    radial: {
        machine: 'RADIAL',
        qrAlmacen: '',
        qrProveedor: '',
        loteProveedor: '',
        feeder: '',
        polaridad: '',
        persona: '',
        partNumber: '',
        spec: '',
        dbPolarity: '',
        feederValid: false,
        polarityValid: false,
        allDataReady: false
    }
};

// Función para mostrar modal con mensaje
function showModal(title, message, isError = false, autoClose = false) {
    const modal = new bootstrap.Modal(document.getElementById('messageModal'));
    const titleElement = document.getElementById('messageModalLabel');
    const bodyElement = document.getElementById('messageModalBody');
    const closeButton = document.querySelector('#messageModal .btn-close');
    const footerButton = document.querySelector('#messageModal .modal-footer .btn');
    
    titleElement.textContent = title;
    bodyElement.innerHTML = message;
    
    // Cambiar color según el tipo de mensaje
    const modalContent = document.querySelector('#messageModal .modal-content');
    if (isError) {
        modalContent.style.borderColor = '#dc3545';
        titleElement.style.color = '#ff6b6b';
    } else {
        modalContent.style.borderColor = '#28a745';
        titleElement.style.color = '#51cf66';
    }
    
    // Controlar visibilidad de botones según autoClose
    if (autoClose) {
        closeButton.style.display = 'none';
        footerButton.style.display = 'none';
    } else {
        closeButton.style.display = 'block';
        footerButton.style.display = 'block';
    }
    
    modal.show();
    
    // Auto cerrar después de 2 segundos si autoClose es true
    if (autoClose) {
        setTimeout(() => {
            modal.hide();
        }, 2000);
    }
}

// Función para extraer número de parte del QR almacén
function extractPartNumber(qrAlmacen) {
    if (!qrAlmacen) return null;
    
    // Buscar el primer separador y tomar todo lo anterior
    const separators = [',', "'", '_', '-'];
    for (const sep of separators) {
        const index = qrAlmacen.indexOf(sep);
        if (index !== -1) {
            return qrAlmacen.substring(0, index);
        }
    }
    
    // Si no hay separadores, retornar el string completo
    return qrAlmacen;
}

// Función para hacer peticiones a la API
async function apiRequest(endpoint, data = null) {
    try {
        const options = {
            method: data ? 'POST' : 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        };
        
        if (data) {
            options.body = JSON.stringify(data);
        }
        
        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('Error en API request:', error);
        throw error;
    }
}

// Función para buscar información de parte
async function searchPart(machineType, qrAlmacen) {
    const state = machineStates[machineType];
    
    try {
        // Extraer número de parte
        const partNumber = extractPartNumber(qrAlmacen);
        if (!partNumber) {
            showModal('Error', 'No se pudo extraer el número de parte del QR almacén', true);
            return;
        }
        
        // Buscar en base de datos
        const result = await apiRequest('/search-part', {
            qr_almacen: qrAlmacen,
            machine: state.machine
        });
        
        if (result.success) {
            // Actualizar estado
            state.partNumber = result.part_number;
            state.spec = result.data.spec;
            state.dbPolarity = result.data.polarity;
            
            // Actualizar UI - Spec
            const specInput = document.getElementById(`${machineType}-spec`);
            specInput.value = result.data.spec;
            specInput.style.backgroundColor = '#1a472a'; // Verde oscuro
            
            // Actualizar UI - Polaridad en bloque de visualización
            const polarityDisplayDiv = document.getElementById(`${machineType}-polaridad-display`);
            if (polarityDisplayDiv) {
                polarityDisplayDiv.innerHTML = `<h1 style="color: white; margin: 0; text-align: center; line-height: 1.2; padding: 20px 0;">${result.data.polarity || 'N/A'}</h1>`;
            }
            
            console.log(`✅ Datos encontrados para ${state.machine}:`, result.data);
        } else {
            showModal('Error', `No se encontraron datos para el número de parte: ${partNumber}`, true);
        }
        
    } catch (error) {
        showModal('Error', 'Error conectando con el servidor. Verifique que el servidor esté ejecutándose.', true);
        console.error('Error buscando parte:', error);
    }
}

// Función para validar feeder
async function validateFeeder(machineType, feederScanned) {
    const state = machineStates[machineType];
    
    if (!state.partNumber) {
        showModal('Error', 'Primero debe escanear el QR almacén', true);
        return;
    }
    
    try {
        const result = await apiRequest('/validate-feeder', {
            part_number: state.partNumber,
            feeder_scanned: feederScanned,
            machine: state.machine
        });
        
        if (result.success) {
            state.feederValid = result.is_valid;
            
            // Actualizar color del input según validación
            const feederInput = document.getElementById(`${machineType}-feeder`);
            if (feederInput) {
                if (result.is_valid) {
                    feederInput.style.backgroundColor = '#1a472a'; // Verde oscuro
                    feederInput.classList.remove('validation-error');
                } else {
                    feederInput.style.backgroundColor = '#7f1d1d'; // Rojo oscuro
                    feederInput.classList.add('validation-error');
                }
            }
            
            // Actualizar bloque de resultado
            updateResultDisplay(machineType);
            
            console.log(`Validación feeder ${state.machine}:`, result.is_valid ? 'OK' : 'NG');
        } else {
            showModal('Error', 'Error validando feeder', true);
        }
        
    } catch (error) {
        showModal('Error', 'Error conectando con el servidor para validar feeder', true);
        console.error('Error validando feeder:', error);
    }
}

// Función para validar polaridad
async function validatePolarity(machineType, polarityScanned) {
    const state = machineStates[machineType];
    
    if (!state.partNumber) {
        showModal('Error', 'Primero debe escanear el QR almacén', true);
        return;
    }
    
    try {
        const result = await apiRequest('/validate-polarity', {
            part_number: state.partNumber,
            polarity_scanned: polarityScanned,
            machine: state.machine
        });
        
        if (result.success) {
            state.polarityValid = result.is_valid;
            
            // Actualizar color de la polaridad en el display del lado derecho
            updatePolarityDisplayColor(machineType, result.is_valid);
            
            // Actualizar color del input según validación
            const polarityInput = document.getElementById(`${machineType}-polaridad`);
            if (polarityInput) {
                if (result.is_valid) {
                    polarityInput.style.backgroundColor = '#1a472a'; // Verde oscuro
                    polarityInput.classList.remove('validation-error');
                } else {
                    polarityInput.style.backgroundColor = '#7f1d1d'; // Rojo oscuro
                    polarityInput.classList.add('validation-error');
                }
            }
            
            // Actualizar color del resultado según validación de polaridad
            updateResultDisplay(machineType, true);
            
            console.log(`Validación polaridad ${state.machine}:`, result.is_valid ? 'OK' : 'NG');
        } else {
            showModal('Error', 'Error validando polaridad', true);
        }
        
    } catch (error) {
        showModal('Error', 'Error conectando con el servidor para validar polaridad', true);
        console.error('Error validando polaridad:', error);
    }
}

// Función para actualizar el color del display de polaridad
function updatePolarityDisplayColor(machineType, isValid) {
    const polarityDisplayDiv = document.getElementById(`${machineType}-polaridad-display`);
    if (polarityDisplayDiv) {
        const currentText = polarityDisplayDiv.querySelector('h1')?.textContent || '';
        if (currentText && currentText !== 'N/A') {
            const color = isValid ? '#22c55e' : '#ef4444'; // Verde si es válido, rojo si no
            polarityDisplayDiv.innerHTML = `<h1 style="color: ${color}; margin: 0; text-align: center; line-height: 1.2; padding: 20px 0;">${currentText}</h1>`;
            console.log(`🎨 Color de polaridad actualizado para ${machineType}: ${isValid ? 'VERDE (válida)' : 'ROJO (inválida)'}`);
        }
    }
}

// Función para actualizar el display de resultado
function updateResultDisplay(machineType, includePolarityValidation = false) {
    const state = machineStates[machineType];
    const resultElement = document.getElementById(`${machineType}-resultado-display`);
    
    if (!resultElement) return;
    
    let resultText = '';
    let resultColor = '';
    
    // Determinar resultado basado en validación de feeder
    if (state.feederValid) {
        resultText = 'OK';
        resultColor = '#22c55e'; // Verde
    } else {
        resultText = 'NG';
        resultColor = '#ef4444'; // Rojo
    }
    
    // Si se incluye validación de polaridad, ajustar color
    if (includePolarityValidation) {
        if (!state.polarityValid) {
            resultText = 'NG';
            resultColor = '#ef4444'; // Rojo si la polaridad no es válida
        }
    }
    
    resultElement.innerHTML = `<h1 style="color: ${resultColor}; margin: 0; text-align: center; line-height: 1.2; padding: 20px 0;">${resultText}</h1>`;
}

// Función para verificar si todos los datos están listos
function checkAllDataReady(machineType) {
    const state = machineStates[machineType];
    
    state.allDataReady = (
        state.qrAlmacen &&
        state.qrProveedor &&
        state.loteProveedor &&
        state.feeder &&
        state.polaridad &&
        state.persona &&
        state.partNumber
    );
    
    return state.allDataReady;
}

// Función para guardar en historial
async function saveToHistory(machineType) {
    const state = machineStates[machineType];
    
    // Verificar si hay errores
    if (!state.feederValid || !state.polarityValid) {
        let errorMessage = 'Se encontraron los siguientes errores:<br><br>';
        
        if (!state.feederValid) {
            errorMessage += '• El feeder escaneado no coincide con el esperado<br>';
        }
        
        if (!state.polarityValid) {
            errorMessage += '• La polaridad escaneada no coincide con la esperada<br>';
        }
        
        showModal('Errores de Validación', errorMessage, true);
        return;
    }
    
    // Verificar que todos los campos estén completos
    if (!checkAllDataReady(machineType)) {
        showModal('Error', 'Todos los campos deben estar completos antes de guardar', true);
        return;
    }
    
    try {
        const historyData = {
            posicion_de_feeder: `${state.machine}_${state.feeder}`,
            qr_almacen: state.qrAlmacen,
            numero_de_parte: state.partNumber,
            spec: state.spec,
            qr_de_proveedor: state.qrProveedor,
            numero_de_lote_proveedor: state.loteProveedor,
            polaridad: state.polaridad,
            persona: state.persona
        };
        
        const result = await apiRequest('/save-history', historyData);
        
        if (result.success) {
            showModal('Éxito', '✅ Cambio de material registrado exitosamente', false, true);
            
            // Limpiar formulario
            clearMachineForm(machineType);
        } else {
            showModal('Error', 'Error guardando el registro', true);
        }
        
    } catch (error) {
        showModal('Error', 'Error conectando con el servidor para guardar', true);
        console.error('Error guardando historial:', error);
    }
}

// Función para limpiar formulario
function clearMachineForm(machineType) {
    const state = machineStates[machineType];
    
    console.log(`🧹 Limpiando formulario para máquina ${machineType.toUpperCase()}`);
    
    // Resetear estado
    Object.assign(state, {
        qrAlmacen: '',
        qrProveedor: '',
        loteProveedor: '',
        feeder: '',
        polaridad: '',
        persona: '',
        partNumber: '',
        spec: '',
        dbPolarity: '',
        feederValid: false,
        polarityValid: false,
        allDataReady: false
    });
    
    // Limpiar inputs
    const inputs = [
        'qr-almacen', 'qr-proveedor', 'lote-proveedor', 
        'feeder', 'polaridad', 'persona', 'spec'
    ];
    
    inputs.forEach(inputName => {
        const input = document.getElementById(`${machineType}-${inputName}`);
        if (input) {
            input.value = '';
            input.style.backgroundColor = ''; // Resetear color
            input.classList.remove('validation-error'); // Remover clase de error
            console.log(`✅ Limpiado input: ${machineType}-${inputName}`);
        }
    });
    
    // Limpiar displays de visualización
    const polarityDisplay = document.getElementById(`${machineType}-polaridad-display`);
    if (polarityDisplay) {
        polarityDisplay.innerHTML = '';
        console.log(`✅ Limpiado display de polaridad: ${machineType}-polaridad-display`);
    } else {
        console.warn(`⚠️ No se encontró elemento: ${machineType}-polaridad-display`);
    }
    
    const resultDisplay = document.getElementById(`${machineType}-resultado-display`);
    if (resultDisplay) {
        resultDisplay.innerHTML = '';
        console.log(`✅ Limpiado display de resultado: ${machineType}-resultado-display`);
    } else {
        console.warn(`⚠️ No se encontró elemento: ${machineType}-resultado-display`);
    }
    
    console.log(`✨ Formulario ${machineType.toUpperCase()} completamente limpiado`);
}

// Event listeners para inputs
function setupEventListeners() {
    ['axial', 'radial'].forEach(machineType => {
        const state = machineStates[machineType];
        
        // QR Almacén - Trigger búsqueda cuando se termine de escribir
        const qrAlmacenInput = document.getElementById(`${machineType}-qr-almacen`);
        qrAlmacenInput.addEventListener('input', function(e) {
            state.qrAlmacen = e.target.value;
        });
        qrAlmacenInput.addEventListener('blur', function(e) {
            if (e.target.value.length > 5) { // Búsqueda cuando hay suficientes caracteres
                searchPart(machineType, e.target.value);
            }
        });
        
        // QR Proveedor
        document.getElementById(`${machineType}-qr-proveedor`).addEventListener('input', function(e) {
            state.qrProveedor = e.target.value;
        });
        
        // Lote Proveedor
        document.getElementById(`${machineType}-lote-proveedor`).addEventListener('input', function(e) {
            state.loteProveedor = e.target.value;
        });
        
        // Feeder - Trigger validación cuando se termine de escribir
        const feederInput = document.getElementById(`${machineType}-feeder`);
        feederInput.addEventListener('input', function(e) {
            state.feeder = e.target.value;
        });
        feederInput.addEventListener('blur', function(e) {
            if (e.target.value && state.partNumber) {
                validateFeeder(machineType, e.target.value);
            }
        });
        
        // Polaridad - Trigger validación cuando se termine de escribir
        const polaridadInput = document.getElementById(`${machineType}-polaridad`);
        polaridadInput.addEventListener('input', function(e) {
            state.polaridad = e.target.value;
        });
        polaridadInput.addEventListener('blur', function(e) {
            if (e.target.value && state.partNumber) {
                validatePolarity(machineType, e.target.value);
            }
        });
        
        // Persona
        document.getElementById(`${machineType}-persona`).addEventListener('input', function(e) {
            state.persona = e.target.value;
        });
        
        // Botón CAMBIAR
        document.getElementById(`${machineType}-cambiar`).addEventListener('click', function() {
            saveToHistory(machineType);
        });
    });
}

// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Aplicación IMD Control iniciada');
    setupEventListeners();
    
    // Verificar conexión con el servidor
    fetch(`${API_BASE_URL}/health`)
        .then(response => response.json())
        .then(data => {
            console.log('✅ Servidor conectado:', data);
        })
        .catch(error => {
            console.error('❌ Error conectando con servidor:', error);
            showModal('Error de Conexión', 
                'No se pudo conectar con el servidor. Verifique que esté ejecutándose en http://127.0.0.1:5000', 
                true);
        });
});
  </script>
</body>
</html>